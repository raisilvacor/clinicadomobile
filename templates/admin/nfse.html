{% extends "admin/base.html" %}

{% block title %}NFS-e - Emiss√£o de Nota Fiscal de Servi√ßo{% endblock %}

{% block content %}
<div class="admin-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2>üßæ NFS-e - Emiss√£o de Nota Fiscal de Servi√ßo</h2>
        <a href="{{ url_for('admin_nfse_config') }}" class="btn btn-secondary">‚öôÔ∏è Configura√ß√µes</a>
    </div>
    
    {% if not nfse_config or not nfse_config.get('api_token') %}
    <div style="background: rgba(255, 140, 0, 0.2); border: 2px solid #ff8c00; border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem;">
        <h3 style="color: #ff8c00; margin-bottom: 1rem;">‚ö†Ô∏è Configura√ß√£o Necess√°ria</h3>
        <p style="color: #ffffff; margin-bottom: 1rem;">
            Para emitir NFS-e, √© necess√°rio configurar as credenciais da API primeiro.
        </p>
        <a href="{{ url_for('admin_nfse_config') }}" class="btn btn-primary">Configurar Agora</a>
    </div>
    {% endif %}
    
    <div class="admin-card" style="background: #0d0d0d;">
        <h3 style="color: #ff8c00; margin-bottom: 1.5rem;">üìù Emitir Nova NFS-e</h3>
        
        <form id="nfseForm" onsubmit="emitirNFSe(event)">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label>CPF/CNPJ do Tomador <span style="color: #ff8c00;">*</span></label>
                    <input type="text" id="tomador_cpf_cnpj" required placeholder="00000000000 ou 00000000000100" maxlength="18">
                </div>
                
                <div class="form-group">
                    <label>Nome/Raz√£o Social <span style="color: #ff8c00;">*</span></label>
                    <input type="text" id="tomador_nome" required placeholder="Nome completo ou Raz√£o Social">
                </div>
                
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="tomador_email" placeholder="email@exemplo.com">
                </div>
                
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" id="tomador_telefone" placeholder="(00) 00000-0000">
                </div>
            </div>
            
            <h4 style="color: #ff8c00; margin: 2rem 0 1rem 0;">üìç Endere√ßo do Tomador</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label>Logradouro</label>
                    <input type="text" id="tomador_endereco" placeholder="Rua, Avenida, etc.">
                </div>
                
                <div class="form-group">
                    <label>N√∫mero</label>
                    <input type="text" id="tomador_numero" placeholder="123">
                </div>
                
                <div class="form-group">
                    <label>Bairro</label>
                    <input type="text" id="tomador_bairro" placeholder="Nome do bairro">
                </div>
                
                <div class="form-group">
                    <label>CEP</label>
                    <input type="text" id="tomador_cep" placeholder="00000-000" maxlength="9">
                </div>
                
                <div class="form-group">
                    <label>Munic√≠pio</label>
                    <input type="text" id="tomador_municipio" placeholder="Nome do munic√≠pio">
                </div>
                
                <div class="form-group">
                    <label>C√≥digo do Munic√≠pio (IBGE)</label>
                    <input type="text" id="tomador_codigo_municipio" placeholder="7 d√≠gitos" maxlength="7">
                </div>
                
                <div class="form-group">
                    <label>UF</label>
                    <select id="tomador_uf" style="width: 100%;">
                        <option value="">Selecione</option>
                        <option value="AC">AC</option>
                        <option value="AL">AL</option>
                        <option value="AP">AP</option>
                        <option value="AM">AM</option>
                        <option value="BA">BA</option>
                        <option value="CE">CE</option>
                        <option value="DF">DF</option>
                        <option value="ES">ES</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="MT">MT</option>
                        <option value="MS">MS</option>
                        <option value="MG">MG</option>
                        <option value="PA">PA</option>
                        <option value="PB">PB</option>
                        <option value="PR">PR</option>
                        <option value="PE">PE</option>
                        <option value="PI">PI</option>
                        <option value="RJ">RJ</option>
                        <option value="RN">RN</option>
                        <option value="RS">RS</option>
                        <option value="RO">RO</option>
                        <option value="RR">RR</option>
                        <option value="SC">SC</option>
                        <option value="SP">SP</option>
                        <option value="SE">SE</option>
                        <option value="TO">TO</option>
                    </select>
                </div>
            </div>
            
            <h4 style="color: #ff8c00; margin: 2rem 0 1rem 0;">üíº Dados do Servi√ßo</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label>Discrimina√ß√£o do Servi√ßo <span style="color: #ff8c00;">*</span></label>
                    <textarea id="discriminacao" required rows="4" placeholder="Descreva detalhadamente o servi√ßo prestado..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Valor dos Servi√ßos (R$) <span style="color: #ff8c00;">*</span></label>
                    <input type="number" id="valor_servicos" required step="0.01" min="0" placeholder="0.00">
                </div>
            </div>
            
            <div id="nfseError" class="alert alert-error hidden"></div>
            <div id="nfseSuccess" class="alert alert-success hidden"></div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                üßæ Emitir NFS-e
            </button>
        </form>
    </div>
    
    <div id="nfseResult" class="admin-card hidden" style="background: #0d0d0d; margin-top: 2rem;">
        <h3 style="color: #28a745; margin-bottom: 1rem;">‚úÖ NFS-e Emitida com Sucesso!</h3>
        <div id="nfseResultContent"></div>
    </div>
</div>

<script>
async function emitirNFSe(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Emitindo...';
    
    document.getElementById('nfseError').classList.add('hidden');
    document.getElementById('nfseSuccess').classList.add('hidden');
    document.getElementById('nfseResult').classList.add('hidden');
    
    const formData = {
        tomador_cpf_cnpj: document.getElementById('tomador_cpf_cnpj').value,
        tomador_nome: document.getElementById('tomador_nome').value,
        tomador_email: document.getElementById('tomador_email').value,
        tomador_telefone: document.getElementById('tomador_telefone').value,
        tomador_endereco: document.getElementById('tomador_endereco').value,
        tomador_numero: document.getElementById('tomador_numero').value,
        tomador_bairro: document.getElementById('tomador_bairro').value,
        tomador_cep: document.getElementById('tomador_cep').value,
        tomador_municipio: document.getElementById('tomador_municipio').value,
        tomador_codigo_municipio: document.getElementById('tomador_codigo_municipio').value,
        tomador_uf: document.getElementById('tomador_uf').value,
        discriminacao: document.getElementById('discriminacao').value,
        valor_servicos: parseFloat(document.getElementById('valor_servicos').value)
    };
    
    try {
        const response = await fetch('/admin/nfse/emit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('nfseSuccess').textContent = 'NFS-e emitida com sucesso!';
            document.getElementById('nfseSuccess').classList.remove('hidden');
            
            let resultHtml = `
                <div style="background: #1a1a1a; padding: 1.5rem; border-radius: 10px; margin-top: 1rem;">
                    <p><strong style="color: #ff8c00;">N√∫mero da NFS-e:</strong> <span style="color: #fff;">${data.numero_nfse || 'N/A'}</span></p>
                    <p><strong style="color: #ff8c00;">C√≥digo de Verifica√ß√£o:</strong> <span style="color: #fff;">${data.codigo_verificacao || 'N/A'}</span></p>
            `;
            
            if (data.link_nfse) {
                resultHtml += `<p><a href="${data.link_nfse}" target="_blank" class="btn btn-primary" style="margin-top: 1rem;">üîó Ver NFS-e Online</a></p>`;
            }
            
            if (data.pdf) {
                resultHtml += `<p><a href="${data.pdf}" target="_blank" class="btn btn-secondary" style="margin-top: 0.5rem;">üìÑ Baixar PDF</a></p>`;
            }
            
            resultHtml += `</div>`;
            
            document.getElementById('nfseResultContent').innerHTML = resultHtml;
            document.getElementById('nfseResult').classList.remove('hidden');
            
            // Scroll para o resultado
            document.getElementById('nfseResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            document.getElementById('nfseError').textContent = data.error || 'Erro ao emitir NFS-e';
            document.getElementById('nfseError').classList.remove('hidden');
        }
    } catch (error) {
        document.getElementById('nfseError').textContent = 'Erro ao emitir NFS-e. Verifique sua conex√£o.';
        document.getElementById('nfseError').classList.remove('hidden');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

// M√°scaras de input
document.getElementById('tomador_cpf_cnpj')?.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '');
});

document.getElementById('tomador_telefone')?.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    } else {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    e.target.value = value;
});

document.getElementById('tomador_cep')?.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
    e.target.value = value;
});
</script>
{% endblock %}

