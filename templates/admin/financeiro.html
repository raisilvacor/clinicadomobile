{% extends "admin/base.html" %}

{% block title %}Gest√£o Financeira{% endblock %}

{% block extra_css %}
<style>
    .financial-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 2px solid #333333;
    }
    
    .financial-card h3 {
        color: #ff8c00;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        border-bottom: 2px solid #ff8c00;
        padding-bottom: 0.5rem;
    }
    
    .financial-metric {
        background: rgba(255, 140, 0, 0.1);
        border: 1px solid #ff8c00;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    .financial-metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #ff8c00;
        margin: 0.5rem 0;
    }
    
    .financial-metric-label {
        color: #cccccc;
        font-size: 1rem;
        margin-top: 0.5rem;
    }
    
    .date-filter {
        background: rgba(255, 140, 0, 0.05);
        border: 2px solid #ff8c00;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .date-filter form {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .date-filter input[type="date"] {
        padding: 0.75rem;
        background: #0d0d0d;
        border: 2px solid #ff8c00;
        border-radius: 8px;
        color: #ffffff;
        font-size: 1rem;
    }
    
    .date-filter button {
        padding: 0.75rem 2rem;
        background: #ff8c00;
        color: #000000;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .date-filter button:hover {
        background: #ffaa00;
    }
    
    .table-container {
        overflow-x: auto;
        margin-top: 1rem;
    }
    
    .financial-table {
        width: 100%;
        border-collapse: collapse;
        background: #0d0d0d;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .financial-table th {
        background: #ff8c00;
        color: #000000;
        padding: 1rem;
        text-align: left;
        font-weight: bold;
    }
    
    .financial-table td {
        padding: 1rem;
        border-bottom: 1px solid #333333;
        color: #ffffff;
    }
    
    .financial-table tr:hover {
        background: rgba(255, 140, 0, 0.1);
    }
    
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    
    .badge-danger {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
    }
    
    .badge-success {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid #28a745;
    }
    
    .badge-warning {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
    }
    
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.8); 
    }

    .modal-content {
        background-color: #1a1a1a;
        margin: 10% auto; 
        padding: 2rem;
        border: 2px solid #ff8c00;
        width: 80%; 
        max-width: 500px;
        border-radius: 15px;
        color: white;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #ff8c00;
        text-decoration: none;
        cursor: pointer;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #ff8c00;
    }

    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        background: #0d0d0d;
        border: 1px solid #333;
        border-radius: 5px;
        color: white;
    }
    
    .btn-success {
        background-color: #28a745;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
    }
    
    .btn-success:hover {
        background-color: #218838;
    }
    
    .transaction-type-selector {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .type-option {
        flex: 1;
        padding: 0.5rem;
        text-align: center;
        border: 1px solid #333;
        border-radius: 5px;
        cursor: pointer;
        background: #0d0d0d;
    }
    
    .type-option.active.income {
        background: rgba(40, 167, 69, 0.2);
        border-color: #28a745;
        color: #28a745;
    }
    
    .type-option.active.expense {
        background: rgba(220, 53, 69, 0.2);
        border-color: #dc3545;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
            <h2>üí∞ Gest√£o Financeira Completa</h2>
            <p>Fluxo de caixa, relat√≥rios e m√©tricas</p>
        </div>
        <button onclick="openModal()" style="background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 0.5rem;">
            <span>+</span> Lan√ßar Movimenta√ß√£o
        </button>
    </div>
    
    <!-- Filtro de Data -->
    <div class="date-filter">
        <form method="GET" action="{{ url_for('admin_financeiro') }}">
            <label style="color: #ff8c00; font-weight: bold;">Per√≠odo:</label>
            <input type="date" name="start_date" value="{{ start_date }}" required>
            <span style="color: #ffffff;">at√©</span>
            <input type="date" name="end_date" value="{{ end_date }}" required>
            <button type="submit">üîç Filtrar</button>
        </form>
    </div>
    
    <!-- Cards de Resumo Consolidado -->
    <div class="financial-card">
        <h3>üíµ Fluxo de Caixa (Consolidado)</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div class="financial-metric">
                <div class="financial-metric-label">Entradas Totais</div>
                <div class="financial-metric-value" style="color: #28a745;">R$ {{ "%.2f"|format(financial_data.summary.total_income) }}</div>
                <div class="financial-metric-label">Servi√ßos + Vendas + Outros</div>
            </div>
            <div class="financial-metric">
                <div class="financial-metric-label">Sa√≠das Totais</div>
                <div class="financial-metric-value" style="color: #dc3545;">R$ {{ "%.2f"|format(financial_data.summary.total_expense) }}</div>
                <div class="financial-metric-label">Pe√ßas + Despesas Operacionais</div>
            </div>
            <div class="financial-metric" style="border-color: {{ '#28a745' if financial_data.summary.net_profit >= 0 else '#dc3545' }}; background: {{ 'rgba(40, 167, 69, 0.1)' if financial_data.summary.net_profit >= 0 else 'rgba(220, 53, 69, 0.1)' }};">
                <div class="financial-metric-label">Lucro L√≠quido</div>
                <div class="financial-metric-value" style="color: {{ '#28a745' if financial_data.summary.net_profit >= 0 else '#dc3545' }};">
                    R$ {{ "%.2f"|format(financial_data.summary.net_profit) }}
                </div>
                <div class="financial-metric-label">Resultado do per√≠odo</div>
            </div>
        </div>
    </div>
    
    <!-- Gr√°ficos de Categorias -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="financial-card" style="margin-bottom: 0;">
            <h3>üì• Origem das Receitas</h3>
            <canvas id="incomeChart"></canvas>
        </div>
        <div class="financial-card" style="margin-bottom: 0;">
            <h3>üì§ Destino das Despesas</h3>
            <canvas id="expenseChart"></canvas>
        </div>
    </div>

    <!-- Tabela de Movimenta√ß√µes Recentes -->
    <div class="financial-card">
        <h3>üìã Hist√≥rico de Transa√ß√µes (Fluxo de Caixa)</h3>
        <div class="table-container">
            <table class="financial-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Categoria</th>
                        <th>Descri√ß√£o</th>
                        <th>Valor</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Transa√ß√µes Manuais -->
                    {% for t in financial_data.transactions %}
                    <tr>
                        <td>{{ t.date|default(t.created_at[:10]) }}</td>
                        <td>
                            <span class="badge {{ 'badge-success' if t.type == 'income' else 'badge-danger' }}">
                                {{ 'Entrada' if t.type == 'income' else 'Sa√≠da' }}
                            </span>
                        </td>
                        <td>{{ t.category }}</td>
                        <td>{{ t.description }}</td>
                        <td style="color: {{ '#28a745' if t.type == 'income' else '#dc3545' }}; font-weight: bold;">
                            R$ {{ "%.2f"|format(t.amount) }}
                        </td>
                        <td>
                            <form action="{{ url_for('admin_delete_transaction', transaction_id=t.id) }}" method="POST" onsubmit="return confirm('Tem certeza?');" style="display:inline;">
                                <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% if not financial_data.transactions %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                            Nenhuma transa√ß√£o manual lan√ßada neste per√≠odo.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Dashboard Autom√°tico (Existente - Performance de Reparos) -->
    <div class="financial-card">
        <h3>üöÄ Performance de Reparos</h3>
        
        <!-- Row 1: Metas e Crescimento -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <!-- Card Crescimento -->
            <div style="background: #0d0d0d; padding: 1.5rem; border-radius: 10px; border: 1px solid #333;">
                <h4 style="color: #ccc; margin-bottom: 1rem;">üìà Crescimento (Reparos)</h4>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <span style="font-size: 2.5rem; font-weight: bold; color: {{ '#28a745' if financial_data.dashboard.growth.type == 'positive' else '#dc3545' if financial_data.dashboard.growth.type == 'negative' else '#ffc107' }};">
                            {{ '+' if financial_data.dashboard.growth.type == 'positive' else '' }}{{ financial_data.dashboard.growth.rate }}%
                        </span>
                        <p style="color: #888; margin: 0;">Em rela√ß√£o ao m√™s anterior</p>
                    </div>
                    <div style="font-size: 3rem;">
                        {{ 'üöÄ' if financial_data.dashboard.growth.type == 'positive' else 'üìâ' if financial_data.dashboard.growth.type == 'negative' else '‚öñÔ∏è' }}
                    </div>
                </div>
            </div>

            <!-- Card Meta -->
            <div style="background: #0d0d0d; padding: 1.5rem; border-radius: 10px; border: 1px solid #333;">
                <h4 style="color: #ccc; margin-bottom: 1rem;">üéØ Meta Mensal (Faturamento)</h4>
                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                    <span style="color: #fff; font-weight: bold;">R$ {{ "%.2f"|format(financial_data.dashboard.goal.current) }}</span>
                    <span style="color: #888;">Meta: R$ {{ "%.2f"|format(financial_data.dashboard.goal.target) }}</span>
                </div>
                <div style="background: #333; height: 15px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #ff8c00, #ff0000); width: {{ financial_data.dashboard.goal.progress }}%; height: 100%; border-radius: 10px;"></div>
                </div>
                <p style="color: {{ '#28a745' if financial_data.dashboard.goal.progress >= 100 else '#ffc107' }}; margin-top: 0.5rem; font-weight: bold;">
                    {{ "%.1f"|format(financial_data.dashboard.goal.progress) }}% atingido
                </p>
            </div>
        </div>

        <!-- Row 2: Gr√°ficos Principais -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
            <!-- Gr√°fico Faturamento -->
            <div style="background: #0d0d0d; padding: 1.5rem; border-radius: 10px; border: 1px solid #333;">
                <h4 style="color: #ff8c00; margin-bottom: 1rem; text-align: center;">üí∞ Faturamento (√öltimos 12 Meses)</h4>
                <canvas id="revenueChart"></canvas>
            </div>

            <!-- Gr√°fico Lucro L√≠quido -->
            <div style="background: #0d0d0d; padding: 1.5rem; border-radius: 10px; border: 1px solid #333;">
                <h4 style="color: #28a745; margin-bottom: 1rem; text-align: center;">üí∏ Lucro Operacional (Reparos)</h4>
                <canvas id="profitChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Transa√ß√£o -->
<div id="transactionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 style="color: #ff8c00; margin-bottom: 1.5rem;">Nova Movimenta√ß√£o</h3>
        
        <form action="{{ url_for('admin_add_transaction') }}" method="POST">
            <input type="hidden" name="type" id="transactionType" value="expense">
            
            <div class="transaction-type-selector">
                <div class="type-option" onclick="selectType('income')" id="typeIncome">
                    üí∞ Entrada
                </div>
                <div class="type-option active expense" onclick="selectType('expense')" id="typeExpense">
                    üì§ Sa√≠da
                </div>
            </div>
            
            <div class="form-group">
                <label>Data</label>
                <input type="date" name="date" required value="{{ end_date }}">
            </div>
            
            <div class="form-group">
                <label>Categoria</label>
                <select name="category" id="categorySelect" required>
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <input type="text" name="description" placeholder="Ex: Aluguel, Venda de Capinha, etc." required>
            </div>
            
            <div class="form-group">
                <label>Valor (R$)</label>
                <input type="number" name="amount" step="0.01" min="0" placeholder="0.00" required>
            </div>
            
            <button type="submit" class="btn-success">Salvar Lan√ßamento</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Dados do backend
    const dashboardData = {{ financial_data.dashboard | tojson }};
    const categoriesData = {{ financial_data.categories | tojson }};

    // Fun√ß√µes do Modal
    function openModal() {
        document.getElementById('transactionModal').style.display = 'block';
        selectType('expense'); // Default
    }

    function closeModal() {
        document.getElementById('transactionModal').style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('transactionModal')) {
            closeModal();
        }
    }

    function selectType(type) {
        document.getElementById('transactionType').value = type;
        const incomeBtn = document.getElementById('typeIncome');
        const expenseBtn = document.getElementById('typeExpense');
        const select = document.getElementById('categorySelect');
        
        // Limpar op√ß√µes
        select.innerHTML = '';
        
        if (type === 'income') {
            incomeBtn.className = 'type-option active income';
            expenseBtn.className = 'type-option';
            
            const options = ['Servi√ßos', 'Venda de Acess√≥rios', 'Venda de Aparelhos', 'Outros'];
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                select.appendChild(el);
            });
        } else {
            incomeBtn.className = 'type-option';
            expenseBtn.className = 'type-option active expense';
            
            const options = ['Pe√ßas', 'Aluguel', 'Energia', 'Internet', '√Ågua', 'Sal√°rios', 'Marketing', 'Impostos', 'Outros'];
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                select.appendChild(el);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Configura√ß√£o comum
        Chart.defaults.color = '#cccccc';
        Chart.defaults.borderColor = '#333333';
        
        // 1. Gr√°fico de Faturamento (Performance)
        if (document.getElementById('revenueChart')) {
            new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: dashboardData.labels,
                    datasets: [{
                        label: 'Faturamento',
                        data: dashboardData.revenue,
                        backgroundColor: 'rgba(255, 140, 0, 0.5)',
                        borderColor: '#ff8c00',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => 'R$ ' + value.toLocaleString('pt-BR') }
                        }
                    }
                }
            });
        }

        // 2. Gr√°fico de Lucro (Performance)
        if (document.getElementById('profitChart')) {
            new Chart(document.getElementById('profitChart'), {
                type: 'line',
                data: {
                    labels: dashboardData.labels,
                    datasets: [{
                        label: 'Lucro L√≠quido',
                        data: dashboardData.profit,
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderColor: '#28a745',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => 'R$ ' + value.toLocaleString('pt-BR') }
                        }
                    }
                }
            });
        }
        
        // 3. Gr√°fico de Categorias de Receita
        if (document.getElementById('incomeChart')) {
            const incomeLabels = Object.keys(categoriesData.income);
            const incomeValues = Object.values(categoriesData.income);
            
            new Chart(document.getElementById('incomeChart'), {
                type: 'doughnut',
                data: {
                    labels: incomeLabels.length ? incomeLabels : ['Sem dados'],
                    datasets: [{
                        data: incomeValues.length ? incomeValues : [1],
                        backgroundColor: [
                            '#28a745', '#20c997', '#17a2b8', '#ffc107', '#fd7e14'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }
        
        // 4. Gr√°fico de Categorias de Despesa
        if (document.getElementById('expenseChart')) {
            const expenseLabels = Object.keys(categoriesData.expense);
            const expenseValues = Object.values(categoriesData.expense);
            
            new Chart(document.getElementById('expenseChart'), {
                type: 'doughnut',
                data: {
                    labels: expenseLabels.length ? expenseLabels : ['Sem dados'],
                    datasets: [{
                        data: expenseValues.length ? expenseValues : [1],
                        backgroundColor: [
                            '#dc3545', '#e83e8c', '#6f42c1', '#fd7e14', '#ffc107', '#17a2b8'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }
    });
</script>
{% endblock %}

