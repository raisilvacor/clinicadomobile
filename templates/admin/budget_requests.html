{% extends "admin/base.html" %}

{% block title %}Solicita√ß√µes de Or√ßamento{% endblock %}

{% block content %}
<div class="admin-card">
    <h2>üí∞ Solicita√ß√µes de Or√ßamento</h2>
    <p>Solicita√ß√µes enviadas pelo app mobile dos clientes.</p>

    {% if requests %}
    <div style="margin-top: 2rem;">
        {% for req in requests %}
        <div style="background: #0d0d0d; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid {% if req.status == 'pendente' %}#ff8c00{% else %}#28a745{% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                <div style="flex: 1;">
                    <h3 style="color: #ff8c00; margin: 0 0 0.5rem 0;">
                        ID: {{ req.id }}
                        <span style="padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.85rem; font-weight: bold; margin-left: 1rem;
                            {% if req.status == 'pendente' %}
                                background: rgba(255, 140, 0, 0.2); color: #ff8c00; border: 1px solid #ff8c00;
                            {% else %}
                                background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745;
                            {% endif %}">
                            {{ req.status|upper }}
                        </span>
                    </h3>
                    <p style="color: #999; margin: 0; font-size: 0.9rem;">
                        Data: {{ req.created_at[:16] if req.created_at else 'N/A' }}
                    </p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    {% if req.status == 'pendente' %}
                    <button onclick="createRepairFromRequest('{{ req.id }}')" class="btn btn-primary" style="background: #28a745;">
                        ‚ûï Criar Reparo
                    </button>
                    {% endif %}
                    <button onclick="deleteBudgetRequest('{{ req.id }}')" class="btn btn-secondary" style="background: #dc3545;">
                        üóëÔ∏è Excluir
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div>
                    <strong style="color: #ff8c00;">Cliente:</strong>
                    <p style="color: #ffffff; margin: 0.25rem 0;">{{ req.customer_name }}</p>
                </div>
                <div>
                    <strong style="color: #ff8c00;">Telefone:</strong>
                    <p style="color: #ffffff; margin: 0.25rem 0;">{{ req.customer_phone }}</p>
                </div>
                {% if req.customer_email %}
                <div>
                    <strong style="color: #ff8c00;">E-mail:</strong>
                    <p style="color: #ffffff; margin: 0.25rem 0;">{{ req.customer_email }}</p>
                </div>
                {% endif %}
                {% if req.customer_cpf %}
                <div>
                    <strong style="color: #ff8c00;">CPF:</strong>
                    <p style="color: #ffffff; margin: 0.25rem 0;">{{ req.customer_cpf }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Score de Risco do Cliente -->
            {% if req.risk_score %}
            <div style="margin-top: 1rem; padding: 1rem; border-radius: 10px; 
                {% if req.risk_score.level == 'high' %}
                    background: rgba(220, 53, 69, 0.2); border: 2px solid #dc3545;
                {% elif req.risk_score.level == 'medium' %}
                    background: rgba(255, 193, 7, 0.2); border: 2px solid #ffc107;
                {% else %}
                    background: rgba(40, 167, 69, 0.2); border: 2px solid #28a745;
                {% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h4 style="margin: 0; color: {% if req.risk_score.level == 'high' %}#dc3545{% elif req.risk_score.level == 'medium' %}#ffc107{% else %}#28a745{% endif %};">
                            {{ req.risk_score.label }}
                        </h4>
                        <p style="margin: 0.5rem 0 0 0; color: #ffffff; font-size: 0.9rem;">
                            Score: {{ req.risk_score.score }} pontos
                        </p>
                    </div>
                    <div style="flex: 1; max-width: 400px;">
                        <div style="font-size: 0.85rem; color: #cccccc;">
                            {% if req.risk_score.details.total_repairs > 0 %}
                            <p style="margin: 0.25rem 0;">
                                <strong>Total de reparos:</strong> {{ req.risk_score.details.total_repairs }}
                            </p>
                            {% endif %}
                            {% if req.risk_score.details.warranty_claims > 0 %}
                            <p style="margin: 0.25rem 0; color: #ffc107;">
                                ‚ö†Ô∏è Acionou garantia: {{ req.risk_score.details.warranty_claims }} vez(es)
                            </p>
                            {% endif %}
                            {% if req.risk_score.details.abandoned_devices > 0 %}
                            <p style="margin: 0.25rem 0; color: #dc3545;">
                                üö® Abandonou aparelho: {{ req.risk_score.details.abandoned_devices }} vez(es)
                            </p>
                            {% endif %}
                            {% if req.risk_score.details.value_disputes > 0 %}
                            <p style="margin: 0.25rem 0; color: #ffc107;">
                                üí∞ Discutiu valor: {{ req.risk_score.details.value_disputes }} vez(es)
                            </p>
                            {% endif %}
                            {% if req.risk_score.details.cancelled_after_analysis > 0 %}
                            <p style="margin: 0.25rem 0; color: #dc3545;">
                                ‚ùå Cancelou ap√≥s an√°lise: {{ req.risk_score.details.cancelled_after_analysis }} vez(es)
                            </p>
                            {% endif %}
                            {% if req.risk_score.details.open_repairs > 0 %}
                            <p style="margin: 0.25rem 0; color: #ffc107;">
                                üìã OS abertas simult√¢neas: {{ req.risk_score.details.open_repairs }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% if req.risk_score.level == 'high' %}
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(220, 53, 69, 0.3); border-radius: 8px;">
                    <p style="margin: 0; color: #ffffff; font-weight: bold;">
                        ‚ö†Ô∏è ATEN√á√ÉO: Cliente de alto risco! Considere exigir sinal maior ou recusar o servi√ßo.
                    </p>
                </div>
                {% elif req.risk_score.level == 'medium' %}
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255, 193, 7, 0.3); border-radius: 8px;">
                    <p style="margin: 0; color: #ffffff; font-weight: bold;">
                        ‚ö†Ô∏è Cliente de m√©dio risco. Fique atento e considere exigir sinal.
                    </p>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #333333;">
                <strong style="color: #ff8c00;">Dispositivo:</strong>
                <p style="color: #ffffff; margin: 0.25rem 0;">
                    <strong>Marca:</strong> {{ req.device_brand }} | 
                    <strong>Modelo:</strong> {{ req.device_model }}
                </p>
            </div>
            
            <div style="margin-top: 1rem;">
                <strong style="color: #ff8c00;">Defeito:</strong>
                <p style="color: #ffffff; margin: 0.25rem 0;">{{ req.defect }}</p>
            </div>
            
            <div style="margin-top: 1rem;">
                <strong style="color: #ff8c00;">Descri√ß√£o:</strong>
                <p style="color: #ffffff; margin: 0.25rem 0; white-space: pre-wrap;">{{ req.description }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #999;">
        <p>Nenhuma solicita√ß√£o de or√ßamento encontrada.</p>
    </div>
    {% endif %}
</div>

<script>
function createRepairFromRequest(requestId) {
    if (confirm('Deseja criar um novo reparo a partir desta solicita√ß√£o?')) {
        window.location.href = `/admin/repairs/new?from_request=${requestId}`;
    }
}

async function deleteBudgetRequest(requestId) {
    if (!confirm('Tem certeza que deseja excluir esta solicita√ß√£o de or√ßamento? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/budget-requests/${requestId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Solicita√ß√£o exclu√≠da com sucesso!');
            window.location.reload();
        } else {
            alert(data.error || 'Erro ao excluir solicita√ß√£o');
        }
    } catch (error) {
        alert('Erro ao excluir solicita√ß√£o. Tente novamente.');
        console.error('Erro:', error);
    }
}
</script>
{% endblock %}

