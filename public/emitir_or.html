<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emitir Ordem de Retirada - TechCell</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <!-- html2pdf for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .or-form-container {
            display: grid;
            gap: 2rem;
        }

        .info-box {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 15px;
            padding: 2rem;
            border: 2px solid #333333;
        }

        .info-box h3 {
            color: #ff8c00;
            margin-bottom: 1rem;
        }

        .info-item {
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .info-item strong {
            color: #ff8c00;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            color: #ffffff;
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #333333;
            background: #0d0d0d;
            color: #ffffff;
            font-family: inherit;
            min-height: 100px;
        }

        .validation-message {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffc107;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none; /* Hidden by default */
        }

        .checklist-section {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 15px;
            padding: 2rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .checklist-section:hover {
            border-color: #ff8c00;
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.2);
        }

        .checklist-section h3 {
            color: #ff8c00;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-box {
            background: #0d0d0d;
            padding: 1.5rem;
            border-radius: 10px;
            border: 2px solid #333333;
        }

        .test-box h4 {
            color: #ff8c00;
            margin-bottom: 1rem;
        }

        .test-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .test-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #ff8c00;
        }

        .test-item label {
            color: #cccccc;
            cursor: pointer;
        }

        /* Risk Score Styles */
        .risk-high {
            background: rgba(220, 53, 69, 0.1) !important;
            border-color: #dc3545 !important;
        }
        .risk-high h3 {
            color: #dc3545 !important;
        }

        .risk-medium {
            background: rgba(255, 193, 7, 0.1) !important;
            border-color: #ffc107 !important;
        }
        .risk-medium h3 {
            color: #ffc107 !important;
        }

        .risk-low {
            background: rgba(40, 167, 69, 0.1) !important;
            border-color: #28a745 !important;
        }
        .risk-low h3 {
            color: #28a745 !important;
        }

        /* Hidden printable area */
        #printable-or {
            display: none;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <nav class="admin-nav">
            <a href="admin.html" class="admin-logo" style="text-decoration: none;">
                <img src="images/logo.png" alt="Logo Cl√≠nica CELL">
            </a>
            <button class="admin-menu-toggle" aria-label="Menu" onclick="toggleAdminMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="admin-menu-overlay" onclick="toggleAdminMenu()"></div>
            <ul class="admin-nav-links">
                <li><a href="admin.html">Dashboard</a></li>
                <li><a href="novo_reparo.html">Novo Reparo</a></li>
                <li><a href="emitir_or.html" class="active">Emitir OR</a></li>
                <li><a href="index.html" style="color: #ff8c00;">Voltar ao Site</a></li>
            </ul>
        </nav>
    </header>

    <div class="admin-container">
        <div class="admin-card">
            <h2>üìã Emitir Ordem de Retirada (OR)</h2>
            
            <div id="statusWarning" class="validation-message">
                ‚ö†Ô∏è O reparo precisa estar com status "Conclu√≠do" para emitir a OR.
                <br><br>
                <button onclick="concludeRepair()" class="btn btn-primary btn-sm">Marcar como Conclu√≠do</button>
            </div>

            <div id="mainContent" style="display: none;">
                <p>Preencha os dados para emitir a Ordem de Retirada.</p>

                <div class="or-form-container">
                    <!-- Informa√ß√µes do Reparo -->
                    <div class="info-box" id="repairInfo">
                        <!-- Filled via JS -->
                    </div>

                    <!-- Informa√ß√µes do Cliente -->
                    <div class="info-box" id="customerInfo">
                        <!-- Filled via JS -->
                    </div>

                    <!-- Score de Risco (Mocked/Calculated) -->
                    <div id="riskScoreContainer">
                        <!-- Filled via JS -->
                    </div>

                    <!-- Formul√°rio -->
                    <form id="emitOrForm">
                        <!-- Checklist -->
                        <div class="checklist-section">
                            <h3>‚úÖ Checklist Antifraude de Conclus√£o</h3>
                            <p style="color: #999; margin-bottom: 1rem;">Realize os testes finais obrigat√≥rios.</p>
                            
                            <div class="test-box">
                                <h4>‚úÖ Teste DEPOIS do Reparo</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-power" name="test_after_power">
                                        <label for="test-after-power">Bot√£o Power</label>
                                    </div>
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-volume" name="test_after_volume">
                                        <label for="test-after-volume">Bot√µes de Volume</label>
                                    </div>
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-screen" name="test_after_screen">
                                        <label for="test-after-screen">Tela/Touch</label>
                                    </div>
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-camera" name="test_after_camera">
                                        <label for="test-after-camera">C√¢meras</label>
                                    </div>
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-audio" name="test_after_audio">
                                        <label for="test-after-audio">√Åudio/Microfone</label>
                                    </div>
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-charging" name="test_after_charging">
                                        <label for="test-after-charging">Carregamento</label>
                                    </div>
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-biometry" name="test_after_biometry">
                                        <label for="test-after-biometry">Biometria/FaceID</label>
                                    </div>
                                    <div class="test-item">
                                        <input type="checkbox" id="test-after-wifi" name="test_after_wifi">
                                        <label for="test-after-wifi">Wi-Fi/Bluetooth</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="info-box">
                            <h3>üìù Dados da Ordem de Retirada</h3>
                            
                            <div class="form-group">
                                <label for="observations">Observa√ß√µes (Opcional)</label>
                                <textarea id="observations" name="observations" placeholder="Digite observa√ß√µes sobre a retirada..."></textarea>
                            </div>
                        </div>

                        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-file-pdf"></i> Emitir e Baixar OR
                            </button>
                            <a href="index.html" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Template for PDF Generation -->
    <div id="printable-or" style="padding: 40px; background: white; color: black; font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
        <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 style="margin: 0; color: #ff8c00;">TECHCELL</h1>
            <p style="margin: 5px 0 0;">Assist√™ncia T√©cnica Especializada</p>
            <h2 style="margin-top: 20px;">ORDEM DE RETIRADA</h2>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
                <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">Cliente</h3>
                <p><strong>Nome:</strong> <span id="pdf-client-name"></span></p>
                <p><strong>CPF:</strong> <span id="pdf-client-cpf"></span></p>
                <p><strong>Telefone:</strong> <span id="pdf-client-phone"></span></p>
            </div>
            <div>
                <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">Aparelho</h3>
                <p><strong>Modelo:</strong> <span id="pdf-device-model"></span></p>
                <p><strong>IMEI:</strong> <span id="pdf-device-imei"></span></p>
                <p><strong>ID OS:</strong> <span id="pdf-repair-id"></span></p>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">Servi√ßo Realizado</h3>
            <p><strong>Problema Relatado:</strong> <span id="pdf-problem"></span></p>
            <p><strong>Observa√ß√µes:</strong> <span id="pdf-observations"></span></p>
        </div>

        <div style="margin-bottom: 40px;">
            <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">Termo de Garantia e Responsabilidade</h3>
            <p style="font-size: 12px; text-align: justify; line-height: 1.5;">
                Declaro ter recebido o aparelho acima descrito em perfeitas condi√ß√µes de funcionamento, conforme testes realizados presencialmente na retirada.
                A garantia cobre apenas o servi√ßo realizado e a pe√ßa substitu√≠da pelo prazo de 90 dias, n√£o cobrindo danos causados por mau uso, quedas, contato com l√≠quidos ou interven√ß√£o de terceiros.
            </p>
        </div>

        <div style="margin-top: 80px; text-align: center;">
            <div style="border-top: 1px solid #000; width: 60%; margin: 0 auto 10px;"></div>
            <p>Assinatura do Cliente</p>
        </div>
        
        <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666;">
            <p>Data de Retirada: <span id="pdf-date"></span></p>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const repairId = urlParams.get('id');
        let currentRepair = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!repairId) {
                alert('ID do reparo n√£o fornecido.');
                window.location.href = 'admin.html';
                return;
            }

            currentRepair = repairManager.getRepair(repairId);
            if (!currentRepair) {
                alert('Reparo n√£o encontrado.');
                window.location.href = 'admin.html';
                return;
            }

            renderRepairInfo();
            checkStatus();
        });

        function checkStatus() {
            const warning = document.getElementById('statusWarning');
            const content = document.getElementById('mainContent');

            if (currentRepair.status !== 'concluido' && currentRepair.status !== 'retirado') {
                warning.style.display = 'block';
                content.style.display = 'none';
            } else {
                warning.style.display = 'none';
                content.style.display = 'block';
            }
        }

        function concludeRepair() {
            if (confirm('Deseja marcar este reparo como CONCLU√çDO e prosseguir?')) {
                repairManager.updateRepair(currentRepair.id, { status: 'concluido' });
                window.location.reload();
            }
        }

        function renderRepairInfo() {
            // Render Repair Info
            document.getElementById('repairInfo').innerHTML = `
                <h3>üì± Informa√ß√µes do Reparo</h3>
                <div class="info-item"><strong>ID do Reparo:</strong> ${currentRepair.id}</div>
                <div class="info-item"><strong>Dispositivo:</strong> ${currentRepair.device_name || 'N/A'}</div>
                <div class="info-item"><strong>Modelo:</strong> ${currentRepair.device_model || 'N/A'}</div>
                <div class="info-item"><strong>IMEI:</strong> ${currentRepair.device_imei || 'N/A'}</div>
            `;

            // Render Customer Info
            document.getElementById('customerInfo').innerHTML = `
                <h3>üë§ Informa√ß√µes do Cliente</h3>
                <div class="info-item"><strong>Nome:</strong> ${currentRepair.customer_name || 'N/A'}</div>
                <div class="info-item"><strong>Telefone:</strong> ${currentRepair.customer_phone || 'N/A'}</div>
                <div class="info-item"><strong>CPF:</strong> ${currentRepair.customer_cpf || 'N/A'}</div>
            `;

            // Calculate and Render Risk Score (Simple Mock Logic)
            const repairs = repairManager.getAllRepairs();
            const customerRepairs = repairs.filter(r => 
                r.customer_cpf === currentRepair.customer_cpf || 
                (r.customer_name === currentRepair.customer_name && r.customer_name)
            );
            
            // Simple risk logic based on history count
            const repairCount = customerRepairs.length;
            let riskLevel = 'low';
            let riskLabel = '‚úÖ Cliente Seguro';
            let riskScore = 100;

            if (repairCount > 5) {
                riskLevel = 'medium';
                riskLabel = '‚ö†Ô∏è Cliente Recorrente (M√©dio Risco)';
                riskScore = 60;
            }
            
            // Render Risk Score
            const riskContainer = document.getElementById('riskScoreContainer');
            riskContainer.innerHTML = `
                <div class="info-box risk-${riskLevel}">
                    <h3>${riskLabel}</h3>
                    <div class="info-item"><strong>Score:</strong> ${riskScore} pontos</div>
                    <div class="info-item"><strong>Total de reparos:</strong> ${repairCount}</div>
                </div>
            `;
        }

        document.getElementById('emitOrForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect Checklist Data
            const checklist = {
                power: document.getElementById('test-after-power').checked,
                volume: document.getElementById('test-after-volume').checked,
                screen: document.getElementById('test-after-screen').checked,
                camera: document.getElementById('test-after-camera').checked,
                audio: document.getElementById('test-after-audio').checked,
                charging: document.getElementById('test-after-charging').checked,
                biometry: document.getElementById('test-after-biometry').checked,
                wifi: document.getElementById('test-after-wifi').checked
            };

            const observations = document.getElementById('observations').value;

            // Update Repair
            repairManager.updateRepair(currentRepair.id, {
                status: 'retirado',
                conclusion_date: new Date().toISOString(),
                checklist_after: checklist,
                observations: observations
            });

            // Generate PDF
            await generatePDF(observations);
        });

        async function generatePDF(observations) {
            // Populate PDF Template
            document.getElementById('pdf-client-name').textContent = currentRepair.customer_name;
            document.getElementById('pdf-client-cpf').textContent = currentRepair.customer_cpf || 'N/A';
            document.getElementById('pdf-client-phone').textContent = currentRepair.customer_phone;
            
            document.getElementById('pdf-device-model').textContent = currentRepair.device_model;
            document.getElementById('pdf-device-imei').textContent = currentRepair.device_imei || 'N/A';
            document.getElementById('pdf-repair-id').textContent = currentRepair.id;
            
            document.getElementById('pdf-problem').textContent = currentRepair.problem_description;
            document.getElementById('pdf-observations').textContent = observations || 'Nenhuma observa√ß√£o.';
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString();

            const element = document.getElementById('printable-or');
            element.style.display = 'block'; // Make visible for capture

            const opt = {
                margin: 10,
                filename: `OR-${currentRepair.id}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                await html2pdf().set(opt).from(element).save();
                alert('Ordem de Retirada emitida e baixada com sucesso!');
                window.location.href = 'admin.html';
            } catch (err) {
                console.error('Erro ao gerar PDF:', err);
                alert('Erro ao gerar PDF. Verifique o console.');
            } finally {
                element.style.display = 'none'; // Hide again
            }
        }
    </script>
</body>
</html>